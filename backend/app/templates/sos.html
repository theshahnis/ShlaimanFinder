{% extends "base.html" %}

{% block title %}SOS{% endblock %}

{% block content %}
<h1>SOS Page</h1>
<p>Hold the button for 5 seconds to send an SOS message.</p>
<button id="sosButton">SOS - Need Assistance</button>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sosButton = document.getElementById('sosButton');
    let holdTimer = null;
    let holdStartTime = null;

    // Function to start the hold timer
    function startHoldTimer() {
        holdStartTime = Date.now();
        holdTimer = setInterval(updateButtonColor, 1000);
    }

    // Function to clear the hold timer
    function clearHoldTimer() {
        clearInterval(holdTimer);
        sosButton.style.backgroundColor = ''; // Reset color
        holdStartTime = null;
    }

    function updateButtonColor() {
        const elapsed = (Date.now() - holdStartTime) / 1000;
        const colorValue = Math.min(255, Math.floor(elapsed * 51)); // Darken color progressively
        sosButton.style.backgroundColor = `rgb(${255 - colorValue}, 0, 0)`;
        if (elapsed >= 5) {
            sendSOS();
            clearHoldTimer();
        }
    }

     // Add event listeners for mouse events
     sosButton.addEventListener('mousedown', startHoldTimer);
    sosButton.addEventListener('mouseup', clearHoldTimer);
    sosButton.addEventListener('mouseleave', clearHoldTimer);

    // Add event listeners for touch events
    sosButton.addEventListener('touchstart', startHoldTimer);
    sosButton.addEventListener('touchend', clearHoldTimer);
    sosButton.addEventListener('touchcancel', clearHoldTimer);

    function sendSOS() {
        // Assume current location is obtained from the browser's geolocation API
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                fetch('{{ url_for("sos_bp.send_sos") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ latitude: latitude, longitude: longitude })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }, function(error) {
                alert('Unable to retrieve your location.');
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    }
});
</script>
<style>
    .sos-container {
        text-align: center;
        margin-top: 20px;
    }
    
    #sosButton {
        width: 200px;
        height: 200px;
        font-size: 24px;
        border-radius: 50%;
        background-color: red;
        color: white;
        border: none;
        cursor: pointer;
    }
    
    #sosButton:active {
        transform: scale(0.95);
    }
    </style>
{% endblock %}
