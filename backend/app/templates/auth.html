{% extends "base.html" %}

{% block title %}ShlaimanFinder - Login{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

{% endblock %}

{% block content %}
<div class="wrapper fadeInDown">
  <div id="formContent">
    <!-- Tabs Titles -->
    <h2 id="loginTab" class="active" onclick="showLogin()"> Sign In </h2>
    <h2 id="signupTab" class="inactive underlineHover" onclick="showSignup()">Sign Up </h2>

    <!-- Icon -->
    <div class="fadeIn first">
      <img src="{{ url_for('static', filename='images/logo1.png') }}" id="icon" alt="User Icon" />
    </div>

    <!-- Login Form -->
    <div id="loginForm">
        <form id="loginFormElement">
        <input type="hidden" name="login" value="login">
        <input type="email" id="loginEmail" class="fadeIn second" name="email" placeholder="email" required>
        <input type="password" id="loginPassword" class="fadeIn third" name="password" placeholder="password" required>

        <!-- Custom Checkbox -->
        <div class="checkbox-wrapper-5 fadeIn fourth">
          <label for="check-5">
            <input type="checkbox" id="check-5" name="remember">
            <span class="tick_mark"></span>
          </label>
          <span> Remember me?</span>
        </div>

        <input type="submit" class="fadeIn fifth" value="Log In">
      </form>

      <!-- Remind Password -->
      <div id="formFooter">
        <a class="underlineHover" href="{{ url_for('auth_bp.request_reset') }}">Forgot Password?</a>
      </div>
    </div>

    <!-- Signup Form -->
    <div id="signupForm" style="display: none;">
      <form method="POST" action="{{ url_for('auth_bp.auth_page') }}">
        <input type="hidden" name="signup" value="signup">
        <input type="text" id="signupUsername" class="fadeIn second" name="username" placeholder="username" required>
        <input type="email" id="signupEmail" class="fadeIn second" name="email" placeholder="email" required>
        <input type="password" id="signupPassword" class="fadeIn third" name="password" placeholder="password" required>
        <input type="submit" class="fadeIn fourth" value="Sign Up">
      </form>

      <!-- Redirect to Login -->
      <div id="formFooter">
        <a class="underlineHover" href="#" onclick="showLogin()">Already have an account? Sign In</a>
      </div>
    </div>
  </div>
</div>

<script>
  function showLogin() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('signupForm').style.display = 'none';
    document.getElementById('loginTab').classList.add('active');
    document.getElementById('loginTab').classList.remove('inactive');
    document.getElementById('signupTab').classList.add('inactive');
    document.getElementById('signupTab').classList.remove('active');
  }

  function showSignup() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'block';
    document.getElementById('loginTab').classList.add('inactive');
    document.getElementById('loginTab').classList.remove('active');
    document.getElementById('signupTab').classList.add('active');
    document.getElementById('signupTab').classList.remove('inactive');
  }
   // Handle login form submission
   document.getElementById('loginFormElement').addEventListener('submit', function(event) {
    event.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const remember = document.getElementById('check-5').checked;
    login(email, password, remember);
  });

  // Handle signup form submission
  document.getElementById('signupFormElement').addEventListener('submit', function(event) {
    event.preventDefault();
    const username = document.getElementById('signupUsername').value;
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    signup(username, email, password);
  });

  function clearApiToken() {
    document.cookie = 'api_token=; Max-Age=0; path=/; Secure; HttpOnly';
  }

  function storeApiToken(api_token) {
    document.cookie = `api_token=${api_token}; path=/; Secure; HttpOnly`;
  }

  function getStoredApiToken() {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; api_token=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function login(email, password, remember = false) {
    fetch('/auth/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email: email, password: password, remember: remember })
    })
    .then(response => {
      if (response.ok) {
        return response.json().then(data => {
          if (data.api_token) {
            storeApiToken(data.api_token);  // Store the token in a cookie
            const redirectUrl = data.location || '/profile';  // Use fallback URL if Location header is not present
            console.log(`Redirecting to ${redirectUrl}`);
            window.location.href = redirectUrl;  // Redirect to profile or home page
          } else {
            alert(data.msg);  // Handle login error
          }
        });
      } else {
        throw new Error('Login failed');
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function authenticatedFetch(url, options = {}) {
    const token = getStoredApiToken();
    if (!token) {
      window.location.href = '/auth';  // Redirect to login if no token
      return;
    }

    options.headers = {
      ...options.headers,
      'Authorization': 'Bearer ' + token
    };

    return fetch(url, options)
      .then(response => {
        if (response.status === 401) {
          window.location.href = '/auth';  // Redirect to login if unauthorized
          return;
        }
        return response;
      })
      .catch(error => console.error('Error:', error));
  }

  function logout() {
    clearApiToken();
    window.location.href = '/auth';  // Redirect to login
  }
</script>
{% endblock %}