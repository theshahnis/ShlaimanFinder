{% extends "base.html" %}

{% block title %}ShlaimanFinder - Profile{% endblock %}
{% block content %}
<div class="profile-container">
    <h1>Profile Page</h1>
    <p>Welcome, {{ name }}!</p>
    {% if profile_image %}
        <img src="{{ profile_image }}" alt="Profile Picture" style="width:150px;height:150px;">
    {% endif %}
    <form id="profileForm">
        {{ form.hidden_tag() }}
        <div>
            {{ form.username.label }} {{ form.username }}
        </div>
        <div>
            {{ form.email.label }} {{ form.email }}
        </div>
        <div>
            {{ form.profile_image.label }} {{ form.profile_image }}
        </div>
        <div>
            {{ form.phone_number.label }} {{ form.phone_number }}
        </div>
        <div>
            {{ form.note.label }} {{ form.note }} 
        </div>
        <div>
            {{ form.submit }}
        </div>
    </form>
</div>

<script>
    document.getElementById('profileForm').addEventListener('submit', async function(event) {
        event.preventDefault(); // Prevent the default form submission

        let formData = new FormData(this);
        let jsonData = {};
        formData.forEach((value, key) => {
            if (key === 'profile_image' && value.size > 0) {
                jsonData[key] = value;
            } else {
                jsonData[key] = value;
            }
        });

        const phoneNumberInput = document.getElementById('phone_number');
        let phoneNumber = phoneNumberInput.value;
        if (phoneNumber.startsWith('0')) {
            phoneNumber = phoneNumber.slice(1);
        }
        phoneNumber = '+972' + phoneNumber;
        jsonData['phone_number'] = phoneNumber;

        const response = await fetch('/profile/api', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
            },
            body: JSON.stringify(jsonData)
        });

        if (response.ok) {
            const result = await response.json();
            alert(result.message);
            // Optionally, update the UI with the new profile data
        } else {
            const error = await response.json();
            alert('Error: ' + error.message);
        }
    });

    document.getElementById('phone_number').addEventListener('input', function(event) {
        let value = event.target.value;
        if (value.startsWith('0')) {
            value = value.slice(1);
        }
        event.target.value = value;
    });
</script>
{% endblock %}
