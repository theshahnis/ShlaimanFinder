{% extends "base.html" %}

{% block title %}ShlaimanFinder - Profile{% endblock %}

{% block content %}
<h1>Profile Page</h1>
<p>Welcome, {{ name }}!</p>
{% if profile_image %}
    <img src="{{ profile_image }}" alt="Profile Picture" style="width:150px;height:150px;">
{% endif %}
<form id="profile-form" method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    <div>
        {{ form.username.label }} {{ form.username }}
    </div>
    <div>
        {{ form.email.label }} {{ form.email }}
    </div>
    <div>
        {{ form.profile_image.label }} {{ form.profile_image }}
        <img id="image-preview" src="#" alt="Image Preview" style="display:none; max-width: 100%; height: auto;">
    </div>
    <div>
        {{ form.note.label }} {{ form.note }}
    </div>
    <div>
        <button type="button" id="crop-button" data-toggle="modal" data-target="#cropModal">Crop & Upload</button>
    </div>
    <div>
        {{ form.submit }}
    </div>
</form>

<!-- Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" role="dialog" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropModalLabel">Crop Image</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <img id="image-cropper" src="#" alt="Image for Cropping" style="max-width: 100%; height: auto;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-crop" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var imagePreview = document.getElementById('image-preview');
        var imageCropper = document.getElementById('image-cropper');
        var cropper;

        document.getElementById('profile_image').addEventListener('change', function (event) {
            var files = event.target.files;
            if (files && files.length > 0) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    imageCropper.src = e.target.result;
                    $('#cropModal').modal('show');
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(imageCropper, {
                        aspectRatio: 1, // 1 for square, NaN for free aspect ratio
                        viewMode: 1,
                        movable: true,
                        zoomable: true,
                        rotatable: true,
                        scalable: true
                    });
                };
                reader.readAsDataURL(files[0]);
            }
        });

        document.getElementById('confirm-crop').addEventListener('click', function () {
            var canvas;
            if (cropper) {
                canvas = cropper.getCroppedCanvas({
                    width: 525,
                    height: 700,
                });
                canvas.toBlob(function (blob) {
                    var formData = new FormData();
                    formData.append('profile_image', blob, 'cropped_image.png');
                    fetch('{{ url_for("profile_bp.profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ form.csrf_token.current_token }}' // Ensure CSRF token is included
                        }
                    }).then(function (response) {
                        if (response.ok) {
                            window.location.reload();
                        } else {
                            alert('An error occurred while uploading the image.');
                        }
                    });
                });
                $('#cropModal').modal('hide');
            }
        });
    });
</script>
{% endblock %}
