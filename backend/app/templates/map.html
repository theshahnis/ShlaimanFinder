{% extends "base.html" %}

{% block title %}Map{% endblock %}

{% block content %}
<h1>Friends' Locations</h1>
<div id="map" style="height: 500px; width: 100%;"></div>
<button id="refreshButton" onclick="refreshLocations()">Refresh</button>
<button id="meetingPointButton" onclick="startMeetingPointSelection()">Create Meeting Point</button>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin=""/>

<!-- Custom CSS for Marker Icons -->
<style>
    .custom-marker {
        position: relative;
        width: 50px;
        height: 60px; /* Adjusted for the pin pointer */
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .custom-marker .marker-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
        border: 3px solid white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    .custom-marker::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%) translateY(50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 10px solid white;
    }
</style>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>

<script>
    let map;
    let markers = [];
    let meetingPointMode = false;

    document.addEventListener('DOMContentLoaded', () => {
        initializeMap();
        refreshLocations();
    });

    function initializeMap() {
        const israelCentral = [32.06607860466994, 34.78687443031782];
        map = L.map('map').setView(israelCentral, 11);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        map.on('click', function(e) {
            if (meetingPointMode) {
                const { lat, lng } = e.latlng;
                showMeetingPointForm(lat, lng);
                meetingPointMode = false;
            }
        });
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    function refreshLocations() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                fetch('/location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        latitude: latitude,
                        longitude: longitude
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Location sent successfully:', data);
                    fetchLocations();
                })
                .catch(error => {
                    console.error('Error sending location:', error);
                });
            }, showError);
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    }

    function fetchLocations() {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

    fetch('/locations')
    .then(response => response.json())
    .then(data => {
        data.locations.forEach(location => {
            const position = [location.latitude, location.longitude];
            const customIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-image" style="background-image: url('${location.profile_image}');"></div>`,
                iconSize: [50, 60],
                iconAnchor: [25, 60],
                popupAnchor: [0, -60]
            });

            let popupContent = `
                <b>${location.username}</b><br>
                <p>${location.note || ''}</p>
                <p>Last updated: ${location.created_at}</p>
            `;
            if (location.isMeetingPoint) {
                popupContent += `<p>Remaining time: ${location.remaining_time}</p>`;
            }
            popupContent += `
                <a href="https://www.google.com/maps/dir/?api=1&destination=${location.latitude},${location.longitude}" target="_blank">
                    Navigate to this location
                </a>
            `;

            const marker = L.marker(position, { icon: customIcon }).addTo(map)
                .bindPopup(popupContent);
            markers.push(marker);
        });
    })
    .catch(error => {
        console.error('Error fetching locations:', error);
    });
    }

    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                alert('User denied the request for Geolocation.');
                break;
            case error.POSITION_UNAVAILABLE:
                alert('Location information is unavailable.');
                break;
            case error.TIMEOUT:
                alert('The request to get user location timed out.');
                break;
            case error.UNKNOWN_ERROR:
                alert('An unknown error occurred.');
                break;
        }
    }

    function startMeetingPointSelection() {
        alert('Click on the map to set the meeting point.');
        meetingPointMode = true;
    }

    function showMeetingPointForm(lat, lng) {
    const formHtml = `
        <div id="meetingPointForm" style="position: absolute; top: 20px; left: 20px; background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
            <h3>Create Meeting Point</h3>
            <label for="mpUsername">Username</label>
            <input type="text" id="mpUsername" name="mpUsername"><br>
            <label for="mpNote">Note</label>
            <textarea id="mpNote" name="mpNote"></textarea><br>
            <label for="mpImage">Image</label>
            <input type="file" id="mpImage" name="mpImage"><br>
            <label for="mpDuration">Duration (hours)</label>
            <input type="number" id="mpDuration" name="mpDuration" value="3"><br>
            <button onclick="submitMeetingPoint(${lat}, ${lng})">Submit</button>
            <button onclick="cancelMeetingPoint()">Cancel</button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', formHtml);
}

function submitMeetingPoint(lat, lng) {
    const username = document.getElementById('mpUsername').value;
    const note = document.getElementById('mpNote').value;
    const image = document.getElementById('mpImage').files[0];
    const duration = document.getElementById('mpDuration').value;

    const formData = new FormData();
    formData.append('latitude', lat);
    formData.append('longitude', lng);
    formData.append('username', username);
    formData.append('note', note);
    formData.append('duration', duration);
    if (image) {
        formData.append('image', image);
    }

    fetch('/create_meeting_point', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Meeting point created successfully:', data);
        fetchLocations();
    })
    .catch(error => {
        console.error('Error creating meeting point:', error);
    })
    .finally(() => {
        document.getElementById('meetingPointForm').remove();
    });
}

    function cancelMeetingPoint() {
        document.getElementById('meetingPointForm').remove();
    }
</script>
{% endblock %}
